# SMV 400 Bad Request Error - Complete Fix

## Problem
When clicking "Save All Changes" in the SMV modal, a 400 Bad Request error occurred even after initial fixes.

## Root Cause Analysis

The error was caused by **MongoDB auto-generated fields** being sent back to the API:

1. **stageMap** contained `_id` and `placeholder` fields ‚úÖ FIXED (initial fix)
2. **proposedPublicationActivities** contained `_id` fields ‚ùå DISCOVERED IN THIS FIX
3. **reviewPublicationActivities** contained `_id` fields ‚ùå DISCOVERED IN THIS FIX

## The Problem in Detail

When data is loaded from MongoDB, each subdocument gets auto-generated fields:
```javascript
// What MongoDB returns
{
  proposedPublicationActivities: [
    {
      _id: "507f1f77bcf86cd799439011",  // ‚ùå Auto-generated by MongoDB
      __v: 0,                             // ‚ùå Version key
      name: "Draft SMV for publication",
      status: "Completed",
      dateCompleted: "2025-01-15",
      remarks: "Done",
      isHeader: false,
      isNote: false
    }
  ]
}
```

When we try to **save this back**, MongoDB validation fails because:
- `_id` field causes conflicts (trying to create new subdocument with existing ID)
- Extra fields not in schema cause validation errors
- Mongoose can't properly update subdocuments with conflicting IDs

## The Solution

**Sanitize all arrays before sending to backend** - only include schema-valid fields.

### Code Changes in `frontend/src/pages/SMVMonitoringPage.jsx`

#### Before (Problematic):
```javascript
// Line ~353-358
if (allData.proposedPublicationActivities) {
  updateData.proposedPublicationActivities = allData.proposedPublicationActivities; // ‚ùå Sends _id
}

if (allData.reviewPublicationActivities) {
  updateData.reviewPublicationActivities = allData.reviewPublicationActivities; // ‚ùå Sends _id
}
```

#### After (Fixed):
```javascript
// Clean proposed publication activities
if (allData.proposedPublicationActivities) {
  updateData.proposedPublicationActivities = allData.proposedPublicationActivities.map(activity => ({
    name: activity.name,
    status: activity.status || 'Not Completed',
    dateCompleted: activity.dateCompleted || '',
    remarks: activity.remarks || '',
    isHeader: activity.isHeader || false,
    isNote: activity.isNote || false
  }));
}

// Clean review publication activities
if (allData.reviewPublicationActivities) {
  updateData.reviewPublicationActivities = allData.reviewPublicationActivities.map(activity => ({
    name: activity.name,
    status: activity.status || 'Not Completed',
    dateCompleted: activity.dateCompleted || '',
    remarks: activity.remarks || ''
  }));
}
```

### What This Does:

1. **`.map()` creates new objects** - doesn't copy `_id`, `__v`, etc.
2. **Explicitly includes only schema fields**:
   - Proposed Publication: `name`, `status`, `dateCompleted`, `remarks`, `isHeader`, `isNote`
   - Review & Publication: `name`, `status`, `dateCompleted`, `remarks`
3. **Provides defaults** for optional fields using `||` operator
4. **Applied to both code paths**:
   - Main save handler (line ~353)
   - Error recovery path for 409 conflicts (line ~462)

## Schema Reference

From `backend/src/models/SMVMonitoring.js`:

```javascript
// Tab 3 - Proposed Publication Activities
proposedPublicationActivities: [{
  name: String,
  status: { type: String, enum: ["Not Started", "Not Completed", "Completed"] },
  dateCompleted: String,
  remarks: String,
  isHeader: Boolean,
  isNote: Boolean
}]

// Tab 4 - Review & Publication Activities
reviewPublicationActivities: [{
  name: String,
  status: { type: String, enum: ["Not Started", "Not Completed", "Completed"] },
  dateCompleted: String,
  remarks: String
}]
```

## Complete Data Sanitization Pattern

All data sent to backend is now sanitized:

```javascript
const updateData = {};

// 1. Timeline - convert dates to ISO
if (allData.timeline) {
  const timeline = {};
  Object.keys(allData.timeline).forEach(key => {
    if (allData.timeline[key]) {
      const value = allData.timeline[key];
      timeline[key] = value.includes('T') ? value : new Date(value).toISOString();
    }
  });
  updateData.timeline = timeline;
}

// 2. stageMap - remove _id, placeholder, keep only valid fields
if (allData.stageMap) {
  const cleanedStageMap = {};
  Object.keys(allData.stageMap).forEach(stage => {
    const stageActivities = allData.stageMap[stage];
    if (Array.isArray(stageActivities)) {
      cleanedStageMap[stage] = stageActivities
        .filter(activity => !activity.placeholder)
        .map(activity => ({
          name: activity.name,
          status: activity.status || 'Not Started',
          dateCompleted: activity.dateCompleted || '',
          remarks: activity.remarks || ''
        }));
    }
  });
  updateData.stageMap = cleanedStageMap;
  updateData.activities = convertToActivitiesArray(cleanedStageMap);
}

// 3. Proposed Publication Activities - remove _id
if (allData.proposedPublicationActivities) {
  updateData.proposedPublicationActivities = allData.proposedPublicationActivities.map(activity => ({
    name: activity.name,
    status: activity.status || 'Not Completed',
    dateCompleted: activity.dateCompleted || '',
    remarks: activity.remarks || '',
    isHeader: activity.isHeader || false,
    isNote: activity.isNote || false
  }));
}

// 4. Review & Publication Activities - remove _id
if (allData.reviewPublicationActivities) {
  updateData.reviewPublicationActivities = allData.reviewPublicationActivities.map(activity => ({
    name: activity.name,
    status: activity.status || 'Not Completed',
    dateCompleted: activity.dateCompleted || '',
    remarks: activity.remarks || ''
  }));
}
```

## Testing Steps

1. ‚úÖ **Open SMV modal** for any LGU
2. ‚úÖ **Tab 1 (Timeline)**: Change any date ‚Üí Save ‚Üí Should work
3. ‚úÖ **Tab 2 (Development)**: Change activity status ‚Üí Save ‚Üí Should work
4. ‚úÖ **Tab 3 (Proposed Publication)**: Change status/remarks ‚Üí Save ‚Üí Should work
5. ‚úÖ **Tab 4 (Review & Publication)**: Change status/remarks ‚Üí Save ‚Üí Should work
6. ‚úÖ **Refresh page**: All changes should persist
7. ‚úÖ **Console**: No 400 errors, only success messages

## Debugging Added

Added console logging to see what's being sent:

```javascript
// Line ~365
console.log("üì§ Sending update data to backend:", JSON.stringify(updateData, null, 2));
```

This helps verify that:
- No `_id` fields are present
- Only schema-valid fields are included
- Data types are correct

## Expected Console Output (After Fix)

**Before clicking Save:**
```
üì§ Sending update data to backend: {
  "stageMap": { ... },
  "activities": [ ... ],
  "proposedPublicationActivities": [
    {
      "name": "Draft SMV for publication",
      "status": "Completed",
      "dateCompleted": "2025-01-15",
      "remarks": "Done",
      "isHeader": false,
      "isNote": false
      // ‚úÖ NO _id field!
    }
  ],
  "reviewPublicationActivities": [ ... ]
}
```

**After successful save:**
```
‚úÖ Token added to request
‚úÖ Changes saved successfully!
(No 400 error!)
```

## Files Modified

1. **frontend/src/pages/SMVMonitoringPage.jsx**
   - Line ~353-370: Added sanitization for proposed/review activities (main save)
   - Line ~462-479: Added same sanitization for error recovery path
   - Line ~365: Added debug logging

## Critical Fix: Stage Name Mapping

### Additional Error Discovered:
```
activities.18.category: `Finalization of Proposed SMV` is not a valid enum value for path `category`.
```

**Root Cause**: Frontend modal uses **"Finalization of Proposed SMV"** as a stage name, but backend schema only accepts **"Finalization"**.

**Backend Enum Values** (from `backend/src/models/SMVMonitoring.js`):
```javascript
enum: [
  "Preparatory",
  "Data Collection",
  "Data Analysis",
  "Preparation of Proposed SMV",
  "Public Consultation",
  "Review by RO",
  "Submission to BLGF CO",
  "DOF Review",
  "Valuation Testing",
  "Finalization",  // ‚Üê Only "Finalization" is valid
]
```

**Frontend Stage Name** (from `SetTimelineModal.jsx`):
```javascript
"Finalization of Proposed SMV": [...]  // ‚ùå Not in backend enum
```

**Solution**: Map frontend stage names to backend enum values before sending:

```javascript
// Map frontend stage names to backend enum values
const stageNameMap = {
  "Finalization of Proposed SMV": "Finalization",
  // Add other mappings if needed
};

// Use mapped name when creating activities
const backendCategory = stageNameMap[stage] || stage;
const activityData = {
  name: activity.name,
  category: backendCategory,  // ‚úÖ Uses "Finalization" instead of "Finalization of Proposed SMV"
  status: activity.status || 'Not Started',
  remarks: activity.remarks || ''
};
```

Applied to both code paths (main save + 409 error recovery).

## Result

üéâ **400 Bad Request Error Completely Resolved!**

All 4 tabs in the SMV modal now save correctly:
- ‚úÖ Timeline (dates)
- ‚úÖ Development (stageMap activities with proper enum mapping)
- ‚úÖ Proposed Publication (proposed activities)
- ‚úÖ Review & Publication (review activities)

Data persists correctly after page refresh, and console shows only success messages.
